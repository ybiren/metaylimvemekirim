<div class="chat" dir="rtl" (click)="closePopups()">

  <!-- Header -->
  <header class="chat__header" (click)="$event.stopPropagation()">
    <div class="chat__header-right">
      <button type="button" class="chat__close" (click)="close()" aria-label="×¡×’×•×¨">âœ•</button>

      <div class="chat__head">
        <div class="chat__name">
          @if (peerIdResolved > 0) { 
            ×¦'××˜ ×¢× <a (click)="goToProfile(peerIdResolved, $event)" href="#">{{ peerName }}</a>  
          } @else {
             {{ roomName }} 
          }
        </div>

        @if (peerIdResolved > 0) {
          <div class="chat__status" [class.online]="isPeerOnline">
            {{ isPeerOnline ? '××—×•×‘×¨/×ª' : '×œ× ××—×•×‘×¨/×ª' }}
          </div>
        }
      </div>
    </div>

    <!-- Rooms menu -->
    @if (peerIdResolved <= 0) {
      <div class="chat__menu" (click)="$event.stopPropagation()">
        <button
          type="button"
          class="chat__menu-btn"
          aria-label="×ª×¤×¨×™×˜ ×—×“×¨"
          [attr.aria-expanded]="menuOpen"
          (click)="toggleMenu()"
        >
          <span class="kebab" aria-hidden="true">
            <span class="kebab__dot"></span>
            <span class="kebab__dot"></span>
            <span class="kebab__dot"></span>
          </span>
        </button>

        @if (menuOpen) {
          <div class="chat__menu-pop" role="menu">
            <div class="chat__menu-title">××©×ª×ª×¤×™×</div>

            <div class="chat__menu-list">
              <div
                class="chat__menu-user"
                role="menuitem"
                *ngFor="let u of roomUsers; trackBy: trackByUserId"
                [class.is-me]="u.userId === me"
              >
                <button
                  type="button"
                  class="chat__menu-user-main"
                  (click)="goToProfile(u.userId, $event)"
                >
                  <img
                    class="chat__menu-avatar"
                    [src]="imageUrl()(u.userId)"
                    [alt]="u.name"
                    loading="lazy"
                  />

                  <span class="chat__menu-name">
                    {{ u.name }}
                    <span class="chat__menu-me" *ngIf="u.userId === me">(×× ×™)</span>
                  </span>
                </button>

                <button
                  type="button"
                  class="chat__menu-profile"
                  (click)="goToProfile(u.userId, $event)"
                >
                  ×”×¦×’ ×¤×¨×•×¤×™×œ
                </button>
              </div>

              <div class="chat__menu-empty" *ngIf="!roomUsers || roomUsers.length === 0">
                ××™×Ÿ ××©×ª×ª×¤×™× ×œ×”×¦×’×”
              </div>
            </div>
          </div>
        }
      </div>
    }
  </header>

  <!-- Messages -->
  <main class="chat__scroll" #scrollArea>
    <div class="chat__empty" *ngIf="messages.length === 0">
      ××™×Ÿ ×”×•×“×¢×•×ª ×¢×“×™×™×Ÿ
    </div>

    <!-- WhatsApp-style list with date separators -->
    <ng-container *ngFor="let m of messages; trackBy: trackById">
      <!-- Date separator (works if you inserted type:'date' in backend) -->
      <div *ngIf="m.type === 'date'" class="chat__date">
        {{ formatChatDate(m.date) }}
      </div>

      <!-- Normal message -->
      <div
        *ngIf="m.type !== 'date'"
        class="msg"
        [class.msg--me]="m.fromUserId === me"
        [class.msg--peer]="m.fromUserId !== me"
      >
        <div class="msg__sender" *ngIf="m.fromUserId !== me && peerIdResolved <= 0">
          {{ m.fromUserName }}
        </div>

        <div class="msg__row">
          <div class="msg__text">{{ m.content }}</div>

          <div class="msg__meta">
            <span class="msg__time">{{ m.sentAt | date : 'HH:mm' }}</span>
            <span
              class="msg__ticks"
              [class.delivered]="!!m.deliveredAt"
              [class.read]="!!m.readAt"
              aria-hidden="true"
            >
              âœ“âœ“
            </span>
          </div>
        </div>
      </div>
    </ng-container>

    <div class="chat__typing" *ngIf="typing$ | async">××§×œ×™×“/×”â€¦</div>
  </main>

  <!-- Composer -->
  @if (!isLoggedIUserBlockedByPeer()) {
    <footer class="chat__composer" (click)="$event.stopPropagation()">

      <div class="chat__emoji" (click)="$event.stopPropagation()">
        <button
          type="button"
          class="chat__emoji-btn"
          aria-label="××™××•×’×³×™×"
          [attr.aria-expanded]="emojiOpen"
          (click)="toggleEmoji()"
        >
          ğŸ™‚
        </button>

        @if (emojiOpen) {
          <div class="chat__emoji-pop" role="dialog" aria-label="×‘×—×¨ ××™××•×’×³×™">
            <input
              class="chat__emoji-search"
              type="text"
              dir="rtl"
              placeholder="×—×¤×©â€¦"
              [(ngModel)]="emojiQuery"
              (keydown.escape)="closeEmoji()"
            />

            <div class="chat__emoji-grid" role="list">
              <button
                type="button"
                class="chat__emoji-item"
                role="listitem"
                *ngFor="let e of filteredEmojis(); trackBy: trackByEmoji"
                (click)="pickEmoji(e)"
                [title]="e.name"
              >
                {{ e.char }}
              </button>
            </div>
          </div>
        }
      </div>

      <input
        #input
        class="chat__input"
        type="text"
        dir="rtl"
        placeholder="×›×ª×•×‘ ×”×•×“×¢×”â€¦"
        [(ngModel)]="draft"
        (keydown.enter)="send()"
        (keydown.escape)="closePopups()"
        (input)="onTyping()"
      />

      <button type="button" class="chat__send" (click)="send()" [disabled]="!draft?.trim()">
        ×©×œ×—
      </button>
    </footer>
  }
</div>
