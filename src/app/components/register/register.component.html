<form class="form" [formGroup]="form" (ngSubmit)="onSubmit()" dir="rtl">
  <!-- Intro block -->
  <section class="intro card">
    @if(!user()) {
    <h1 class="title">הרשמה לפגוש אותי</h1>
    <p>
      ברוכים הבאים לרשת החברתית פגוש אותי<br>
      כאן תוכלו ליצור ולחפש אירועים מעניינים, ליצור קשרים חברתיים חדשים ולהצטרף לקהילות מעניינות.
      ההרשמה והשימוש באתר הינם <strong>חינם</strong>.
    </p>
    <p class="muted">
      <a href="feedback.asp">אם אינך מצליח להרשם לחץ כאן לעזרה</a>
    </p>
    } @else{
    <h1 class="title">עדכון פרטים</h1>
    }
  </section>

  <!-- Section header -->
  <h2 class="section-header">פרטי החבר</h2>

  <!-- Grid fields -->
  <div class="grid card">
    <label class="label" for="c_name">שם פרטי ושם משפחה*</label>
    <div class="field">
      <input id="c_name" type="text" formControlName="c_name" placeholder="שם בעברית" />
      <div class="errors" *ngIf="f.c_name.touched && f.c_name.invalid">
        <small *ngIf="f.c_name.errors?.required">שדה חובה</small>
        <small *ngIf="f.c_name.errors?.hebrewOnly">נא להזין שם בעברית בלבד</small>
      </div>
    </div>

    @if(user()) {
    <label class="label" for="c_height">גובה</label>
    <div class="field">
      <div>
        <input id="c_height" type="number" formControlName="c_height" placeholder="0" />&nbsp;בסנטימטרים
      </div>
    </div>
    }

    <label class="label" for="c_gender">מין*</label>
    <div class="field">
      <select id="c_gender" formControlName="c_gender">
        <option value="0">בחר</option>
        <option *ngFor="let r of gender" [value]="r.val">{{ r.txt }}</option>
      </select>
      <div class="errors" *ngIf="f.c_gender.touched && f.c_gender.invalid">
        <small *ngIf="f.c_gender.errors?.required">שדה חובה</small>
      </div>
    </div>

    <label class="label">תאריך לידה*</label>
    <div class="field field-row">
      <select formControlName="c_birth_day">
        <option value="0">יום</option>
        <option *ngFor="let d of days" [value]="d">{{ d }}</option>
      </select>
      <select formControlName="c_birth_month">
        <option value="0">חודש</option>
        <option *ngFor="let m of months" [value]="m">{{ m }}</option>
      </select>
      <select formControlName="c_birth_year">
        <option value="0">שנה</option>
        <option *ngFor="let y of years" [value]="y">{{ y }}</option>
      </select>
      <div
        class="errors"
        *ngIf="(f.c_birth_day.touched || f.c_birth_month.touched || f.c_birth_year.touched) &&
               (f.c_birth_day.invalid || f.c_birth_month.invalid || f.c_birth_year.invalid)"
      >
        <small
          *ngIf="f.c_birth_day.errors?.required || f.c_birth_month.errors?.required || f.c_birth_year.errors?.required"
        >
          חובה לבחור תאריך מלא
        </small>
      </div>
    </div>

    <label class="label" for="c_country">אזור מגורים*</label>
    <div class="field">
      <select id="c_country" formControlName="c_country">
        <option value="0">בחר</option>
        <option *ngFor="let r of regions" [value]="r.val">{{ r.txt }}</option>
      </select>
      <div class="errors" *ngIf="f.c_country.touched && f.c_country.invalid">
        <small *ngIf="f.c_country.errors?.required">שדה חובה</small>
      </div>
    </div>

    <label class="label" for="c_pcell">טלפון נייד</label>
    <div class="field">
      <input id="c_pcell" type="text" formControlName="c_pcell" maxlength="13" placeholder="טלפון נייד" />
      <div class="errors" *ngIf="f.c_pcell.touched && f.c_pcell.invalid">
        <small *ngIf="f.c_pcell.errors?.maxlength">עד 13 תווים</small>
        <small *ngIf="f.c_pcell.errors?.pattern">ספרות, רווחים, + ו־- בלבד</small>
      </div>
    </div>

    <label class="label" for="c_email">כתובת מייל*</label>
    <div class="field">
      <input id="c_email" type="email" formControlName="c_email" placeholder="name@example.com" />
      <div class="errors" *ngIf="f.c_email.touched && f.c_email.invalid">
        <small *ngIf="f.c_email.errors?.required">שדה חובה</small>
        <small *ngIf="f.c_email.errors?.email">כתובת מייל לא תקינה</small>
      </div>
    </div>

    <label class="label" for="c_education">השכלה</label>
    <div class="field">
      <select id="c_education" formControlName="c_education" dir="rtl">
        <option value="0">בחר</option>
        <option *ngFor="let e of education" [value]="e.val">{{ e.txt }}</option>
      </select>
    </div>

    <label class="label" for="c_work">תחום עיסוק</label>
    <div class="field">
      <select id="c_work" formControlName="c_work" dir="rtl">
        <option value="0">בחר</option>
        <option *ngFor="let w of work" [value]="w.val">{{ w.txt }}</option>
      </select>
    </div>

    <label class="label" for="c_email2">דואר אלקטרוני*</label>
    <div class="field">
      <input id="c_email2" type="email" formControlName="c_email" placeholder="you@example.com" />
      <div class="errors" *ngIf="f.c_email.touched && f.c_email.invalid">
        <small *ngIf="f.c_email.errors?.required">שדה חובה</small>
        <small *ngIf="f.c_email.errors?.email">דוא&quot;ל לא תקין</small>
      </div>
    </div>

    @if(user()) {
    <label class="label" for="c_url">כתובת אתר אינטרנט</label>
    <div class="field">
      <input id="c_url" type="url" formControlName="c_url" placeholder="http://myurl" dir="ltr" />
      <div class="errors" *ngIf="f.c_url.touched && f.c_url.invalid">
        <small>כתובת לא תקינה</small>
      </div>
    </div>
    }

    @if(user()) {
    <label class="label" for="c_fb">כתובת פרופיל פייסבוק</label>
    <div class="field">
      <input id="c_fb" type="url" formControlName="c_fb" placeholder="" dir="ltr" />
    </div>
    }

    <label class="label" for="c_ff">מצב משפחתי</label>
    <div class="field">
      <select id="c_ff" formControlName="c_ff" dir="rtl">
        <option value="0">בחר</option>
        <option *ngFor="let r of familyStatus" [value]="r.val">{{ r.txt }}</option>
      </select>
    </div>

    @if(user()) {
    <label class="label" for="c_children">מספר ילדים</label>
    <div class="field">
      <select id="c_children" formControlName="c_children" dir="rtl">
        <option value="0">בחר</option>
        <option *ngFor="let c of childrenStatus" [value]="c.val">{{ c.txt }}</option>
      </select>
    </div>
    }

    @if(user()) {
    <label class="label" for="c_smoking">הרגלי עישון</label>
    <div class="field">
      <select id="c_smoking" formControlName="c_smoking" dir="rtl">
        <option value="0">בחר</option>
        <option *ngFor="let s of smokingStatus" [value]="s.val">{{ s.txt }}</option>
      </select>
    </div>
    }

    <!-- Image upload -->
    <label class="label" for="c_image">תמונת פרופיל</label>
    <div class="field">
      <input
        id="c_image"
        type="file"
        accept="image/*"
        (change)="onImageSelected($event)"
        formControlName="c_image"
      />
      <div class="preview-row" *ngIf="imagePreviewUrl">
        <img [src]="imagePreviewUrl" alt="תצוגה מקדימה" class="avatar-preview" />
        <small class="muted">תצוגה מקדימה</small>
      </div>
      <div class="errors" *ngIf="(f.c_image.touched && f.c_image.invalid) || imageError">
        <small *ngIf="f.c_image.errors?.required">שדה חובה</small>
        <small *ngIf="f.c_image.errors?.tooLarge">גודל התמונה לא יכול לעלות על ‎256KB‎</small>
        <small *ngIf="f.c_image.errors?.notImage">נא לבחור קובץ תמונה תקין</small>
        <small *ngIf="imageError">{{ imageError }}</small>
      </div>
    </div>
  </div>

  <!-- Passwords -->
  <h2 class="section-header">סיסמה לכניסה מאובטחת</h2>
  <div class="grid card" [class.group-invalid]="form.hasError('passwordMismatch') && (f.password2.touched || f.password.touched)">
    <label class="label" for="password">סיסמה*</label>
    <div class="field">
      <input id="password" type="password" formControlName="password" maxlength="9" />
      <div class="errors" *ngIf="f.password.touched && f.password.invalid">
        <small *ngIf="f.password.errors?.required">שדה חובה</small>
        <small *ngIf="f.password.errors?.maxlength">עד 9 תווים (כמו במקור)</small>
      </div>
    </div>

    <label class="label" for="password2">אימות סיסמה*</label>
    <div class="field">
      <input id="password2" type="password" formControlName="password2" maxlength="9" />
      <div class="errors" *ngIf="(f.password2.touched && f.password2.invalid) || form.errors?.passwordMismatch">
        <small *ngIf="f.password2.errors?.required">שדה חובה</small>
        <small *ngIf="form.errors?.passwordMismatch">הסיסמאות אינן תואמות</small>
      </div>
    </div>
  </div>

  <!-- About & Interests -->
  <h2 class="section-header">קצת עליך</h2>
  <div class="grid card">
    <label class="label" for="c_details">ספר קצת על עצמך</label>
    <div class="field">
      <textarea id="c_details" formControlName="c_details" rows="5"></textarea>
    </div>

    <label class="label" for="c_details1">תחומי העניין שלי</label>
    <div class="field">
      <textarea
        id="c_details1"
        formControlName="c_details1"
        rows="5"
        placeholder="ספרים, סרטים ותחומים נוספים שמעניינים אותך"
      ></textarea>
    </div>
  </div>

  <!-- 🔽 NEW SECTION: filters for incoming contacts -->
  <h2 class="section-header">מי אני רוצה שיפנה אלי?</h2>
  <div class="grid card">
    <!-- 1) Height range -->
    <label class="label" for="filter_height_min">מגובה עד גובה</label>
    <div class="field range-row">
      <input
        id="filter_height_min"
        type="number"
        formControlName="filter_height_min"
        placeholder="מגובה (ס&quot;מ)"
      />
      <span class="range-separator">עד</span>
      <input
        id="filter_height_max"
        type="number"
        formControlName="filter_height_max"
        placeholder="עד גובה (ס&quot;מ)"
      />
    </div>

    <!-- 2) Age range -->
    <label class="label" for="filter_age_min">מגיל עד גיל</label>
    <div class="field range-row">
      <input
        id="filter_age_min"
        type="number"
        formControlName="filter_age_min"
        placeholder="מגיל"
      />
      <span class="range-separator">עד</span>
      <input
        id="filter_age_max"
        type="number"
        formControlName="filter_age_max"
        placeholder="עד גיל"
      />
    </div>

    <!-- 3) Family status (multi-select via checkboxes) -->
    <label class="label" for="filter_family_status">סטטוס</label>
    <div class="field">
      <div formArrayName="filter_family_status">
        <div *ngFor="let s of familyStatus; let i = index">
          <label>
            <input
              type="checkbox"
              [formControlName]="i"
              dir="rtl"
            />
            {{ s.txt }}
          </label>
        </div>
      </div>
    </div>
  </div>

  <label class="label" for="c_smoking">הרגלי עישון</label>
    <div class="field">
      <select id="c_smoking" formControlName="filter_smoking_status" dir="rtl">
        <option value="0">הכל</option>
        <option [value]="smokingStatus[0].val">{{ smokingStatus[0].txt }}</option>
        <option [value]="smokingStatus[1].val">{{ smokingStatus[1].txt }}</option>
      </select>
    </div>

  <!-- Terms -->
  <details class="card terms">
    <summary>&laquo; לתנאי השימוש באתר</summary>
    <div class="terms-body">
      <p><strong>תנאי השימוש באתר פגוש אותי</strong></p>
      <p>השימוש באתר הינו באחריותו המלאה של המשתמש. (קיצור)</p>
    </div>
  </details>

  <label class="accept-terms">
    <input type="checkbox" formControlName="acceptTerms" />
    אני מאשר/ת שקראתי את תנאי השימוש
  </label>
  <div class="errors" *ngIf="f.acceptTerms.touched && f.acceptTerms.invalid">
    <small>חובה לאשר את תנאי השימוש</small>
  </div>

  <button class="submit-btn" type="submit" [disabled]="submitting()">
    @if (submitting()) { שומר... } @else { שמירה }
  </button>

  <p class="server-msg" *ngIf="serverMsg()">{{ serverMsg() }}</p>
</form>
